<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Planning Pro - Ultimate Complete Edition</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #1a2332;
            --primary-blue: #2d4263;
            --accent-gold: #c9a962;
            --accent-teal: #4a9396;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #6c757d;
            --border-light: #e0e6ed;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
        }

        body {
            font-family: 'Work Sans', -apple-system, system-ui, sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, #e8ecf1 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
            color: white;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: -0.5px;
            margin-bottom: 0.25rem;
            background: linear-gradient(135deg, #ffffff 0%, var(--accent-gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            opacity: 0.7;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .nav-section {
            padding: 1.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.6;
            padding: 0 1.5rem 0.75rem;
            font-weight: 600;
        }

        .nav-item {
            padding: 0.875rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 3px solid transparent;
            font-weight: 500;
            font-size: 0.95rem;
            user-select: none;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent-gold);
        }

        .nav-item.active {
            background: rgba(201, 169, 98, 0.15);
            border-left-color: var(--accent-gold);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.25rem;
            opacity: 0.9;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
            width: calc(100% - 280px);
            max-width: 1400px;
        }

        .page-header {
            background: white;
            padding: 2rem 2.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border-left: 4px solid var(--accent-gold);
        }

        .page-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.75rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            border-top: 3px solid var(--accent-teal);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-family: 'Playfair Display', serif;
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
        }

        .metric-change {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }

        /* Form Sections */
        .form-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
        }

        .section-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-light);
        }

        .subsection-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-blue);
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            letter-spacing: 0.3px;
        }

        .form-input {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Work Sans', sans-serif;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 3px rgba(74, 147, 150, 0.1);
        }

        .form-input:hover {
            border-color: var(--accent-teal);
        }

        .form-input.input-currency {
            font-family: 'Playfair Display', serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .form-input.editing {
            border-color: var(--accent-gold);
            background: var(--input-yellow);
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            user-select: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-teal) 0%, #3a7679 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 147, 150, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 147, 150, 0.4);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .status-warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .status-danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table th {
            background: var(--primary-dark);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background: var(--bg-light);
        }

        .optimal-cell {
            background: rgba(39, 174, 96, 0.1);
            border-left: 3px solid var(--success);
            color: var(--success);
            font-weight: 700;
        }

        /* Monte Carlo Results */
        .mc-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .mc-result-card {
            background: linear-gradient(135deg, white 0%, var(--bg-light) 100%);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--accent-gold);
        }

        .mc-value {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 900;
            margin: 1rem 0;
        }

        .mc-value.success { color: var(--success); }
        .mc-value.warning { color: var(--warning); }
        .mc-value.danger { color: var(--danger); }

        /* Progress Indicators */
        .progress-container {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .progress-bar {
            height: 12px;
            background: var(--border-light);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-teal) 0%, var(--accent-gold) 100%);
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        /* Loading Animation */
        .loading-spinner {
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--accent-teal);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Helper Text */
        .helper-text {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
            font-style: italic;
        }

        /* Summary Box */
        .summary-box {
            background: linear-gradient(135deg, rgba(74, 147, 150, 0.1) 0%, rgba(201, 169, 98, 0.1) 100%);
            border: 2px solid var(--accent-teal);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .summary-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }

        /* Pull Data Button */
        .pull-data-btn {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b08850 100%);
            color: white;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pull-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(192, 154, 98, 0.4);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--border-light);
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--accent-teal);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .toggle-label {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-light);
        }

        .tab {
            padding: 0.875rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-light);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            font-size: 0.95rem;
        }

        .tab:hover {
            color: var(--accent-teal);
        }

        .tab.active {
            color: var(--accent-teal);
            border-bottom-color: var(--accent-teal);
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-top: 1rem;
        }

        /* AI Recommendations */
        .ai-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: none;
            letter-spacing: 0.3px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .ai-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .ai-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ai-recommendations-box {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .ai-recommendations-box h3 {
            color: #667eea;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-recommendations-content {
            white-space: pre-wrap;
            line-height: 1.8;
            color: var(--text-dark);
        }

        .ai-error {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid var(--danger);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            color: var(--danger);
        }

        .ai-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .ai-loading-spinner {
            border: 3px solid var(--border-light);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-dark);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            .main-content {
                margin-left: 240px;
                width: calc(100% - 240px);
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
                padding-top: 4rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .mc-results {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                padding: 1.5rem;
            }

            .page-title {
                font-size: 1.75rem;
            }
        }

        /* Print Styles */
        @media print {
            .sidebar,
            .mobile-menu-toggle,
            .btn {
                display: none;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .metric-card,
            .form-section {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // Utility Functions
        const formatCurrency = (value) => {
            if (!value && value !== 0) return '$0';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        };

        const formatPercent = (value) => {
            if (!value && value !== 0) return '0.0%';
            return (value * 100).toFixed(1) + '%';
        };

        // Monte Carlo Simulation with year-by-year tracking
        function runMonteCarloSimulation(params) {
            const {
                startingValue,
                annualWithdrawal,
                yearsRetirement,
                stockPct,
                bondPct,
                cashPct,
                stockReturn,
                stockVol,
                bondReturn,
                bondVol,
                cashReturn,
                cashVol,
                inflationRate,
                fees = 0,
                taxDrag = 0,
                socialSecurity = 0,
                pension = 0,
                numSims = 1000
            } = params;

            const results = [];
            const yearlyData = Array(yearsRetirement + 1).fill(0).map(() => []);
            
            for (let sim = 0; sim < numSims; sim++) {
                let portfolioValue = startingValue;
                let withdrawal = annualWithdrawal;
                
                yearlyData[0].push(portfolioValue);
                
                for (let year = 0; year < yearsRetirement; year++) {
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z1 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    const z2 = Math.sqrt(-2 * Math.log(u1)) * Math.sin(2 * Math.PI * u2);
                    
                    const stockAnnualReturn = stockReturn + stockVol * z1;
                    const bondAnnualReturn = bondReturn + bondVol * z2;
                    const cashAnnualReturn = cashReturn + cashVol * (Math.random() - 0.5) * 2;
                    
                    let portfolioReturn = stockPct * stockAnnualReturn + 
                                        bondPct * bondAnnualReturn + 
                                        cashPct * cashAnnualReturn;
                    
                    portfolioReturn -= (fees + taxDrag);
                    portfolioValue *= (1 + portfolioReturn);
                    
                    const netWithdrawal = Math.max(0, withdrawal - socialSecurity - pension);
                    portfolioValue -= netWithdrawal;
                    
                    if (portfolioValue <= 0) {
                        portfolioValue = 0;
                        yearlyData[year + 1].push(0);
                        for (let y = year + 2; y <= yearsRetirement; y++) {
                            yearlyData[y].push(0);
                        }
                        break;
                    }
                    
                    yearlyData[year + 1].push(portfolioValue);
                    withdrawal *= (1 + inflationRate);
                }
                
                results.push(portfolioValue);
            }
            
            results.sort((a, b) => a - b);
            
            const yearlyPercentiles = yearlyData.map(yearData => {
                const sorted = [...yearData].sort((a, b) => a - b);
                return {
                    p10: sorted[Math.floor(sorted.length * 0.1)],
                    p25: sorted[Math.floor(sorted.length * 0.25)],
                    p50: sorted[Math.floor(sorted.length * 0.5)],
                    p75: sorted[Math.floor(sorted.length * 0.75)],
                    p90: sorted[Math.floor(sorted.length * 0.9)],
                    survival: sorted.filter(v => v > 0).length / sorted.length
                };
            });
            
            const successRate = results.filter(r => r > 0).length / numSims;
            const median = results[Math.floor(numSims * 0.5)];
            const percentile10 = results[Math.floor(numSims * 0.1)];
            const percentile25 = results[Math.floor(numSims * 0.25)];
            const percentile75 = results[Math.floor(numSims * 0.75)];
            const percentile90 = results[Math.floor(numSims * 0.9)];
            
            return {
                successRate,
                median,
                percentile10,
                percentile25,
                percentile75,
                percentile90,
                yearlyPercentiles
            };
        }

        // Custom Input Component with onBlur handling
        function NumberInput({ value, onChange, className, ...props }) {
            const [localValue, setLocalValue] = useState(value);
            const [isEditing, setIsEditing] = useState(false);

            useEffect(() => {
                setLocalValue(value);
            }, [value]);

            const handleChange = (e) => {
                setLocalValue(e.target.value);
                setIsEditing(true);
            };

            const handleBlur = () => {
                setIsEditing(false);
                const numValue = parseFloat(localValue) || 0;
                onChange(numValue);
            };

            const handleFocus = () => {
                setIsEditing(true);
            };

            return (
                <input
                    type="number"
                    className={`${className} ${isEditing ? 'editing' : ''}`}
                    value={localValue}
                    onChange={handleChange}
                    onBlur={handleBlur}
                    onFocus={handleFocus}
                    {...props}
                />
            );
        }

        // Monte Carlo Chart Component
        function MonteCarloChart({ yearlyPercentiles, yearsRetirement }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !yearlyPercentiles) return;

                const ctx = chartRef.current.getContext('2d');
                
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const years = Array.from({ length: yearsRetirement + 1 }, (_, i) => i);
                
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: '90th Percentile',
                                data: yearlyPercentiles.map(d => d.p90),
                                borderColor: 'rgba(39, 174, 96, 0.8)',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: '75th Percentile',
                                data: yearlyPercentiles.map(d => d.p75),
                                borderColor: 'rgba(74, 147, 150, 0.6)',
                                backgroundColor: 'rgba(74, 147, 150, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: 'Median (50th)',
                                data: yearlyPercentiles.map(d => d.p50),
                                borderColor: 'rgba(201, 169, 98, 1)',
                                backgroundColor: 'rgba(201, 169, 98, 0.1)',
                                borderWidth: 3,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: '25th Percentile',
                                data: yearlyPercentiles.map(d => d.p25),
                                borderColor: 'rgba(243, 156, 18, 0.6)',
                                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: '10th Percentile',
                                data: yearlyPercentiles.map(d => d.p10),
                                borderColor: 'rgba(231, 76, 60, 0.8)',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 11 }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Portfolio Value Over Time (Percentiles)',
                                font: { size: 16, weight: 'bold' }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year',
                                    font: { size: 12, weight: 'bold' }
                                },
                                grid: { display: false }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Portfolio Value',
                                    font: { size: 12, weight: 'bold' }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [yearlyPercentiles, yearsRetirement]);

            return <canvas ref={chartRef}></canvas>;
        }

        // Main App Component
        function FinancialPlanningApp() {
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            // Client Data
            const [clientData, setClientData] = useState({
                name: '',
                age: 35,
                retirementAge: 65,
                lifeExpectancy: 90,
            });
            
            // Net Worth State
            const [netWorth, setNetWorth] = useState({
                checking: 10000,
                savings: 25000,
                moneyMarket: 15000,
                cds: 0,
                cashValueLife: 0,
                brokerage: 100000,
                retirement401k: 150000,
                traditionalIRA: 50000,
                rothIRA: 30000,
                sepIRA: 0,
                college529: 20000,
                hsa: 10000,
                stockOptions: 0,
                otherInvestments: 0,
                primaryHome: 450000,
                vacationHome: 0,
                vehicles: 40000,
                personalProperty: 10000,
                primaryMortgage: 250000,
                otherMortgage: 0,
                heloc: 0,
                autoLoans: 25000,
                studentLoans: 15000,
                creditCards: 5000,
                personalLoans: 0,
                otherLiabilities: 5000
            });
            
            // Cash Flow State
            const [cashFlow, setCashFlow] = useState({
                grossIncome: 150000,
                taxes: 35000,
                expenses: 85000
            });
            
            // Retirement State
            const [retirement, setRetirement] = useState({
                currentSavings: 250000,
                annualContributions: 30000,
                desiredIncome: 80000,
                socialSecurity: 24000,
                pensionIncome: 0,
                inflationRate: 0.03,
                preRetirementReturn: 0.07,
                postRetirementReturn: 0.05
            });
            
            // Tax Efficiency State
            const [taxAccounts, setTaxAccounts] = useState({
                taxDeferred: 200000,
                roth: 30000,
                taxable: 120000
            });
            
            // Monte Carlo State
            const [mcParams, setMcParams] = useState({
                startingValue: 1000000,
                annualWithdrawal: 40000,
                yearsRetirement: 30,
                stockPct: 0.6,
                bondPct: 0.35,
                cashPct: 0.05,
                stockReturn: 0.10,
                stockVol: 0.18,
                bondReturn: 0.045,
                bondVol: 0.06,
                cashReturn: 0.02,
                cashVol: 0.01,
                inflationRate: 0.025,
                fees: 0.005,
                taxDrag: 0.01,
                socialSecurity: 24000,
                pension: 0,
                numSimulations: 1000
            });
            
            const [mcResults, setMcResults] = useState(null);
            const [isSimulating, setIsSimulating] = useState(false);
            const [showAdvancedMC, setShowAdvancedMC] = useState(false);
            const [mcTab, setMcTab] = useState('results');
            
            // AI Recommendations State
            const [aiRecommendations, setAiRecommendations] = useState(null);
            const [isLoadingAI, setIsLoadingAI] = useState(false);
            const [aiError, setAiError] = useState(null);

            // Memoized Calculations
            const liquidAssets = useMemo(() => 
                netWorth.checking + netWorth.savings + netWorth.moneyMarket + 
                netWorth.cds + netWorth.cashValueLife,
                [netWorth.checking, netWorth.savings, netWorth.moneyMarket, netWorth.cds, netWorth.cashValueLife]
            );
            
            const investmentAssets = useMemo(() =>
                netWorth.brokerage + netWorth.retirement401k + netWorth.traditionalIRA +
                netWorth.rothIRA + netWorth.sepIRA + netWorth.college529 + 
                netWorth.hsa + netWorth.stockOptions + netWorth.otherInvestments,
                [netWorth.brokerage, netWorth.retirement401k, netWorth.traditionalIRA,
                 netWorth.rothIRA, netWorth.sepIRA, netWorth.college529, 
                 netWorth.hsa, netWorth.stockOptions, netWorth.otherInvestments]
            );
            
            const personalAssets = useMemo(() =>
                netWorth.primaryHome + netWorth.vacationHome + netWorth.vehicles + 
                netWorth.personalProperty,
                [netWorth.primaryHome, netWorth.vacationHome, netWorth.vehicles, netWorth.personalProperty]
            );
            
            const totalAssets = useMemo(() =>
                liquidAssets + investmentAssets + personalAssets,
                [liquidAssets, investmentAssets, personalAssets]
            );
            
            const totalLiabilities = useMemo(() =>
                netWorth.primaryMortgage + netWorth.otherMortgage + netWorth.heloc +
                netWorth.autoLoans + netWorth.studentLoans + netWorth.creditCards +
                netWorth.personalLoans + netWorth.otherLiabilities,
                [netWorth.primaryMortgage, netWorth.otherMortgage, netWorth.heloc,
                 netWorth.autoLoans, netWorth.studentLoans, netWorth.creditCards,
                 netWorth.personalLoans, netWorth.otherLiabilities]
            );
            
            const totalNetWorth = useMemo(() => totalAssets - totalLiabilities, [totalAssets, totalLiabilities]);

            // Cash Flow Calculations
            const netIncome = useMemo(() => cashFlow.grossIncome - cashFlow.taxes, [cashFlow.grossIncome, cashFlow.taxes]);
            const annualSurplus = useMemo(() => netIncome - cashFlow.expenses, [netIncome, cashFlow.expenses]);
            const savingsRate = useMemo(() => netIncome > 0 ? annualSurplus / netIncome : 0, [annualSurplus, netIncome]);

            // Retirement Metrics
            const yearsToRetirement = useMemo(() => clientData.retirementAge - clientData.age, [clientData.retirementAge, clientData.age]);
            const yearsInRetirement = useMemo(() => clientData.lifeExpectancy - clientData.retirementAge, [clientData.lifeExpectancy, clientData.retirementAge]);
            const capitalNeeded = useMemo(() => retirement.desiredIncome * 25, [retirement.desiredIncome]);
            
            const futureValueOfSavings = useMemo(() =>
                retirement.currentSavings * Math.pow(1 + retirement.preRetirementReturn, yearsToRetirement),
                [retirement.currentSavings, retirement.preRetirementReturn, yearsToRetirement]
            );
            
            const futureValueOfContributions = useMemo(() =>
                retirement.annualContributions * 
                ((Math.pow(1 + retirement.preRetirementReturn, yearsToRetirement) - 1) / retirement.preRetirementReturn),
                [retirement.annualContributions, retirement.preRetirementReturn, yearsToRetirement]
            );
            
            const projectedRetirementSavings = useMemo(() =>
                futureValueOfSavings + futureValueOfContributions,
                [futureValueOfSavings, futureValueOfContributions]
            );
            
            const retirementSurplus = useMemo(() =>
                projectedRetirementSavings - capitalNeeded,
                [projectedRetirementSavings, capitalNeeded]
            );

            // Update handlers
            const updateField = useCallback((setter, field, value) => {
                setter(prev => ({ ...prev, [field]: value }));
            }, []);

            const updateNetWorth = useCallback((field, value) => {
                updateField(setNetWorth, field, value);
            }, [updateField]);

            const updateCashFlow = useCallback((field, value) => {
                updateField(setCashFlow, field, value);
            }, [updateField]);

            const updateRetirement = useCallback((field, value) => {
                updateField(setRetirement, field, value);
            }, [updateField]);

            const updateClientData = useCallback((field, value) => {
                updateField(setClientData, field, value);
            }, [updateField]);

            const updateTaxAccounts = useCallback((field, value) => {
                updateField(setTaxAccounts, field, value);
            }, [updateField]);

            const updateMcParams = useCallback((field, value) => {
                updateField(setMcParams, field, value);
            }, [updateField]);

            // Pull data from Retirement tab to Monte Carlo
            const pullRetirementData = useCallback(() => {
                setMcParams(prev => ({
                    ...prev,
                    startingValue: projectedRetirementSavings,
                    annualWithdrawal: retirement.desiredIncome,
                    yearsRetirement: yearsInRetirement,
                    inflationRate: retirement.inflationRate,
                    socialSecurity: retirement.socialSecurity,
                    pension: retirement.pensionIncome
                }));
            }, [projectedRetirementSavings, retirement, yearsInRetirement]);

            // Get AI Recommendations
            const getAIRecommendations = useCallback(async (context) => {
                setIsLoadingAI(true);
                setAiError(null);
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1500,
                            messages: [{
                                role: "user",
                                content: context
                            }]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const recommendation = data.content.find(c => c.type === "text")?.text;
                    setAiRecommendations(recommendation || "No recommendations generated.");
                } catch (error) {
                    console.error("AI recommendation error:", error);
                    setAiError("Unable to generate recommendations. The API key may be missing or invalid. This feature requires an Anthropic API key.");
                    setAiRecommendations(null);
                } finally {
                    setIsLoadingAI(false);
                }
            }, []);

            // Run Monte Carlo
            const runSimulation = useCallback(() => {
                setIsSimulating(true);
                setTimeout(() => {
                    const results = runMonteCarloSimulation(mcParams);
                    setMcResults(results);
                    setIsSimulating(false);
                }, 100);
            }, [mcParams]);

            // Close mobile menu when changing pages
            useEffect(() => {
                setMobileMenuOpen(false);
            }, [currentPage]);

            // Dashboard Component
            const Dashboard = () => (
                <div className="fade-in">
                    <div className="page-header">
                        <h1 className="page-title">Financial Dashboard</h1>
                        <p className="page-subtitle">Your comprehensive financial overview at a glance</p>
                    </div>

                    <div className="dashboard-grid">
                        <div className="metric-card">
                            <div className="metric-label">Net Worth</div>
                            <div className="metric-value">{formatCurrency(totalNetWorth)}</div>
                            <div className={`metric-change ${totalNetWorth > 0 ? 'positive' : 'negative'}`}>
                                {totalNetWorth > 0 ? '▲' : '▼'} Assets: {formatCurrency(totalAssets)}
                            </div>
                        </div>

                        <div className="metric-card">
                            <div className="metric-label">Annual Net Income</div>
                            <div className="metric-value">{formatCurrency(netIncome)}</div>
                            <div className="metric-change positive">
                                Gross: {formatCurrency(cashFlow.grossIncome)}
                            </div>
                        </div>

                        <div className="metric-card">
                            <div className="metric-label">Savings Rate</div>
                            <div className="metric-value">{formatPercent(savingsRate)}</div>
                            <div className={`metric-change ${savingsRate >= 0.15 ? 'positive' : 'negative'}`}>
                                {savingsRate >= 0.15 ? '✓ On Track' : '⚠ Below 15% Target'}
                            </div>
                        </div>

                        <div className="metric-card">
                            <div className="metric-label">Retirement Progress</div>
                            <div className="metric-value">{formatPercent(retirement.currentSavings / capitalNeeded)}</div>
                            <div className="metric-change positive">
                                Current: {formatCurrency(retirement.currentSavings)}
                            </div>
                        </div>
                    </div>

                    <div className="form-section">
                        <h2 className="section-header">Key Financial Ratios</h2>
                        
                        <div className="progress-container">
                            <div className="progress-label">
                                <span>Emergency Fund Coverage</span>
                                <span>{((liquidAssets / (cashFlow.expenses / 12))).toFixed(1)} months</span>
                            </div>
                            <div className="progress-bar">
                                <div className="progress-fill" style={{width: `${Math.min((liquidAssets / (cashFlow.expenses / 12)) / 6 * 100, 100)}%`}}></div>
                            </div>
                            <p className="helper-text">Target: 3-6 months of expenses</p>
                        </div>

                        <div className="progress-container">
                            <div className="progress-label">
                                <span>Retirement Readiness</span>
                                <span>{((retirement.currentSavings / capitalNeeded) * 100).toFixed(0)}%</span>
                            </div>
                            <div className="progress-bar">
                                <div className="progress-fill" style={{width: `${Math.min((retirement.currentSavings / capitalNeeded) * 100, 100)}%`}}></div>
                            </div>
                            <p className="helper-text">Based on 4% rule and desired income</p>
                        </div>

                        <div className="progress-container">
                            <div className="progress-label">
                                <span>Debt-to-Asset Ratio</span>
                                <span>{formatPercent(totalLiabilities / totalAssets)}</span>
                            </div>
                            <div className="progress-bar">
                                <div className="progress-fill" style={{width: `${Math.min((totalLiabilities / totalAssets) * 100, 100)}%`, background: 'linear-gradient(90deg, var(--danger) 0%, var(--warning) 100%)'}}></div>
                            </div>
                            <p className="helper-text">Lower is better - target below 50%</p>
                        </div>
                    </div>

                    <div className="dashboard-grid">
                        <div className="metric-card">
                            <div className="metric-label">Years to Retirement</div>
                            <div className="metric-value">{yearsToRetirement}</div>
                            <div className="metric-change">At age {clientData.retirementAge}</div>
                        </div>

                        <div className="metric-card">
                            <div className="metric-label">Projected at Retirement</div>
                            <div className="metric-value">{formatCurrency(projectedRetirementSavings)}</div>
                            <div className={`metric-change ${retirementSurplus > 0 ? 'positive' : 'negative'}`}>
                                {retirementSurplus > 0 ? 'Surplus' : 'Shortfall'}: {formatCurrency(Math.abs(retirementSurplus))}
                            </div>
                        </div>

                        <div className="metric-card">
                            <div className="metric-label">Investment Assets</div>
                            <div className="metric-value">{formatCurrency(investmentAssets)}</div>
                            <div className="metric-change">{formatPercent(investmentAssets / totalAssets)} of total</div>
                        </div>

                        <div className="metric-card">
                            <div className="metric-label">Liquid Assets</div>
                            <div className="metric-value">{formatCurrency(liquidAssets)}</div>
                            <div className="metric-change">{formatPercent(liquidAssets / totalAssets)} of total</div>
                        </div>
                    </div>

                    <div className="summary-box">
                        <h3 className="summary-title">Quick Actions</h3>
                        <ul style={{listStyle: 'none', padding: 0}}>
                            {savingsRate < 0.15 && (
                                <li style={{marginBottom: '0.5rem'}}>⚠️ <strong>Increase savings rate</strong> to at least 15% of gross income</li>
                            )}
                            {(liquidAssets / (cashFlow.expenses / 12)) < 3 && (
                                <li style={{marginBottom: '0.5rem'}}>⚠️ <strong>Build emergency fund</strong> to cover 3-6 months of expenses</li>
                            )}
                            {retirementSurplus < 0 && (
                                <li style={{marginBottom: '0.5rem'}}>⚠️ <strong>Retirement shortfall detected</strong> - review Retirement Planning page</li>
                            )}
                            {!mcResults && (
                                <li style={{marginBottom: '0.5rem'}}>💡 <strong>Run Monte Carlo simulation</strong> to test retirement plan probability</li>
                            )}
                        </ul>
                    </div>
                </div>
            );

            // Net Worth Page - Using NumberInput component
            const NetWorthPage = () => {
                const netWorthFields = {
                    liquid: [
                        {key: 'checking', label: 'Checking Accounts'},
                        {key: 'savings', label: 'Savings Accounts'},
                        {key: 'moneyMarket', label: 'Money Market'},
                        {key: 'cds', label: 'Certificates of Deposit'},
                        {key: 'cashValueLife', label: 'Cash Value Life Insurance'}
                    ],
                    investment: [
                        {key: 'brokerage', label: 'Taxable Brokerage'},
                        {key: 'retirement401k', label: '401(k) / 403(b)'},
                        {key: 'traditionalIRA', label: 'Traditional IRA'},
                        {key: 'rothIRA', label: 'Roth IRA'},
                        {key: 'sepIRA', label: 'SEP IRA / SIMPLE'},
                        {key: 'college529', label: '529 College Savings'},
                        {key: 'hsa', label: 'Health Savings Account (HSA)'},
                        {key: 'stockOptions', label: 'Stock Options / RSUs'},
                        {key: 'otherInvestments', label: 'Other Investments'}
                    ],
                    personal: [
                        {key: 'primaryHome', label: 'Primary Residence'},
                        {key: 'vacationHome', label: 'Vacation Home / Real Estate'},
                        {key: 'vehicles', label: 'Vehicles'},
                        {key: 'personalProperty', label: 'Personal Property'}
                    ],
                    liabilities: [
                        {key: 'primaryMortgage', label: 'Primary Mortgage'},
                        {key: 'otherMortgage', label: 'Other Mortgage'},
                        {key: 'heloc', label: 'Home Equity Line of Credit'},
                        {key: 'autoLoans', label: 'Auto Loans'},
                        {key: 'studentLoans', label: 'Student Loans'},
                        {key: 'creditCards', label: 'Credit Card Balances'},
                        {key: 'personalLoans', label: 'Personal Loans'},
                        {key: 'otherLiabilities', label: 'Other Liabilities'}
                    ]
                };

                return (
                    <div className="fade-in">
                        <div className="page-header">
                            <h1 className="page-title">Net Worth Statement</h1>
                            <p className="page-subtitle">Complete balance sheet - Type freely, calculations update when you exit each field</p>
                        </div>

                        <div className="form-section">
                            <h2 className="section-header">ASSETS</h2>
                            
                            <h3 className="subsection-header">Liquid Assets</h3>
                            <div className="form-grid">
                                {netWorthFields.liquid.map(field => (
                                    <div className="form-group" key={field.key}>
                                        <label className="form-label">{field.label}</label>
                                        <NumberInput
                                            value={netWorth[field.key]}
                                            onChange={(value) => updateNetWorth(field.key, value)}
                                            className="form-input input-currency"
                                            min="0"
                                        />
                                    </div>
                                ))}
                            </div>
                            <div className="metric-card" style={{marginTop: '1rem', borderTop: '3px solid var(--accent-teal)'}}>
                                <div className="metric-label">Total Liquid Assets</div>
                                <div className="metric-value">{formatCurrency(liquidAssets)}</div>
                            </div>

                            <h3 className="subsection-header">Investment Assets</h3>
                            <div className="form-grid">
                                {netWorthFields.investment.map(field => (
                                    <div className="form-group" key={field.key}>
                                        <label className="form-label">{field.label}</label>
                                        <NumberInput
                                            value={netWorth[field.key]}
                                            onChange={(value) => updateNetWorth(field.key, value)}
                                            className="form-input input-currency"
                                            min="0"
                                        />
                                    </div>
                                ))}
                            </div>
                            <div className="metric-card" style={{marginTop: '1rem', borderTop: '3px solid var(--accent-teal)'}}>
                                <div className="metric-label">Total Investment Assets</div>
                                <div className="metric-value">{formatCurrency(investmentAssets)}</div>
                            </div>

                            <h3 className="subsection-header">Personal Use Assets</h3>
                            <div className="form-grid">
                                {netWorthFields.personal.map(field => (
                                    <div className="form-group" key={field.key}>
                                        <label className="form-label">{field.label}</label>
                                        <NumberInput
                                            value={netWorth[field.key]}
                                            onChange={(value) => updateNetWorth(field.key, value)}
                                            className="form-input input-currency"
                                            min="0"
                                        />
                                    </div>
                                ))}
                            </div>
                            <div className="metric-card" style={{marginTop: '1rem', borderTop: '3px solid var(--accent-teal)'}}>
                                <div className="metric-label">Total Personal Assets</div>
                                <div className="metric-value">{formatCurrency(personalAssets)}</div>
                            </div>

                            <div className="metric-card" style={{marginTop: '2rem', borderTop: '4px solid var(--accent-gold)'}}>
                                <div className="metric-label">TOTAL ASSETS</div>
                                <div className="metric-value" style={{fontSize: '2.5rem'}}>{formatCurrency(totalAssets)}</div>
                            </div>
                        </div>

                        <div className="form-section">
                            <h2 className="section-header">LIABILITIES</h2>
                            
                            <div className="form-grid">
                                {netWorthFields.liabilities.map(field => (
                                    <div className="form-group" key={field.key}>
                                        <label className="form-label">{field.label}</label>
                                        <NumberInput
                                            value={netWorth[field.key]}
                                            onChange={(value) => updateNetWorth(field.key, value)}
                                            className="form-input input-currency"
                                            min="0"
                                        />
                                    </div>
                                ))}
                            </div>

                            <div className="metric-card" style={{marginTop: '2rem', borderTop: '4px solid var(--danger)'}}>
                                <div className="metric-label">TOTAL LIABILITIES</div>
                                <div className="metric-value" style={{fontSize: '2.5rem'}}>{formatCurrency(totalLiabilities)}</div>
                            </div>
                        </div>

                        <div className="form-section">
                            <div className="metric-card" style={{borderTop: '4px solid var(--accent-teal)', padding: '3rem'}}>
                                <div className="metric-label" style={{fontSize: '1rem'}}>NET WORTH</div>
                                <div className="metric-value" style={{fontSize: '3.5rem', color: totalNetWorth > 0 ? 'var(--success)' : 'var(--danger)'}}>
                                    {formatCurrency(totalNetWorth)}
                                </div>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginTop: '2rem'}}>
                                    <div>
                                        <div className="metric-label">Total Assets</div>
                                        <div style={{fontSize: '1.5rem', fontWeight: 'bold'}}>{formatCurrency(totalAssets)}</div>
                                    </div>
                                    <div>
                                        <div className="metric-label">Total Liabilities</div>
                                        <div style={{fontSize: '1.5rem', fontWeight: 'bold'}}>{formatCurrency(totalLiabilities)}</div>
                                    </div>
                                    <div>
                                        <div className="metric-label">Debt Ratio</div>
                                        <div style={{fontSize: '1.5rem', fontWeight: 'bold'}}>{formatPercent(totalLiabilities / totalAssets)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="form-section">
                            <h2 className="section-header">🤖 AI-Powered Financial Review</h2>
                            <p style={{marginBottom: '1rem', color: 'var(--text-light)'}}>
                                Get personalized recommendations from Claude AI based on your net worth statement.
                            </p>
                            
                            <button 
                                className="ai-button" 
                                onClick={() => getAIRecommendations(`
You are a CFP® professional providing personalized financial advice. Analyze this net worth statement:

ASSETS:
- Liquid Assets: ${formatCurrency(liquidAssets)} (${formatPercent(liquidAssets / totalAssets)} of total)
  * Emergency fund coverage: ${((liquidAssets / (cashFlow.expenses / 12))).toFixed(1)} months of expenses
- Investment Assets: ${formatCurrency(investmentAssets)} (${formatPercent(investmentAssets / totalAssets)} of total)
- Personal Assets: ${formatCurrency(personalAssets)} (${formatPercent(personalAssets / totalAssets)} of total)

LIABILITIES:
- Total Liabilities: ${formatCurrency(totalLiabilities)}
- Debt-to-Asset Ratio: ${formatPercent(totalLiabilities / totalAssets)}

NET WORTH: ${formatCurrency(totalNetWorth)}

ANNUAL FINANCIALS:
- Gross Income: ${formatCurrency(cashFlow.grossIncome)}
- Net Income: ${formatCurrency(netIncome)}
- Expenses: ${formatCurrency(cashFlow.expenses)}
- Savings Rate: ${formatPercent(savingsRate)}

Provide 4-6 specific, actionable recommendations covering:
1. Asset allocation across categories (should they shift between liquid/investment/personal?)
2. Debt reduction priorities and strategy
3. Emergency fund assessment (target: 3-6 months expenses)
4. Opportunities to improve financial position
5. Any red flags or areas of concern

Format as a numbered list. Be direct and specific. Focus on highest-impact actions.
                                `)}
                                disabled={isLoadingAI}
                            >
                                {isLoadingAI ? '⏳ Analyzing Your Finances...' : '🤖 Get AI Financial Review'}
                            </button>

                            {isLoadingAI && (
                                <div className="ai-loading">
                                    <div className="ai-loading-spinner"></div>
                                    <p>Claude is analyzing your financial position...</p>
                                </div>
                            )}

                            {aiError && (
                                <div className="ai-error">
                                    <strong>⚠️ Note:</strong> {aiError}
                                    <p style={{marginTop: '0.5rem', fontSize: '0.875rem'}}>
                                        To enable AI features, you need to add an Anthropic API key. The application will still work without it.
                                    </p>
                                </div>
                            )}

                            {aiRecommendations && (
                                <div className="ai-recommendations-box">
                                    <h3>💡 Claude's Financial Review</h3>
                                    <div className="ai-recommendations-content">
                                        {aiRecommendations}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // Retirement Page
            const RetirementPage = () => (
                <div className="fade-in">
                    <div className="page-header">
                        <h1 className="page-title">Retirement Planning</h1>
                        <p className="page-subtitle">Comprehensive retirement readiness analysis</p>
                    </div>

                    <div className="form-section">
                        <h2 className="section-header">Client Information</h2>
                        <div className="form-grid">
                            <div className="form-group">
                                <label className="form-label">Current Age</label>
                                <NumberInput
                                    value={clientData.age}
                                    onChange={(value) => updateClientData('age', value)}
                                    className="form-input"
                                    min="18"
                                    max="100"
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Retirement Age</label>
                                <NumberInput
                                    value={clientData.retirementAge}
                                    onChange={(value) => updateClientData('retirementAge', value)}
                                    className="form-input"
                                    min="50"
                                    max="80"
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Life Expectancy</label>
                                <NumberInput
                                    value={clientData.lifeExpectancy}
                                    onChange={(value) => updateClientData('lifeExpectancy', value)}
                                    className="form-input"
                                    min="70"
                                    max="120"
                                />
                                <p className="helper-text">Use 90-95 for planning</p>
                            </div>
                        </div>
                    </div>

                    <div className="dashboard-grid">
                        <div className="metric-card">
                            <div className="metric-label">Years to Retirement</div>
                            <div className="metric-value">{yearsToRetirement}</div>
                            <div className="metric-change">Time to accumulate savings</div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-label">Years in Retirement</div>
                            <div className="metric-value">{yearsInRetirement}</div>
                            <div className="metric-change">Planning horizon</div>
                        </div>
                    </div>

                    <div className="form-section">
                        <h2 className="section-header">Current Retirement Savings</h2>
                        <div className="form-grid">
                            <div className="form-group">
                                <label className="form-label">Total Current Savings</label>
                                <NumberInput
                                    value={retirement.currentSavings}
                                    onChange={(value) => updateRetirement('currentSavings', value)}
                                    className="form-input input-currency"
                                    min="0"
                                />
                                <p className="helper-text">All retirement accounts combined</p>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Annual Contributions</label>
                                <NumberInput
                                    value={retirement.annualContributions}
                                    onChange={(value) => updateRetirement('annualContributions', value)}
                                    className="form-input input-currency"
                                    min="0"
                                />
                                <p className="helper-text">How much you save per year</p>
                            </div>
                        </div>
                    </div>

                    <div className="form-section">
                        <h2 className="section-header">Retirement Income Needs</h2>
                        <div className="form-grid">
                            <div className="form-group">
                                <label className="form-label">Desired Annual Income</label>
                                <NumberInput
                                    value={retirement.desiredIncome}
                                    onChange={(value) => updateRetirement('desiredIncome', value)}
                                    className="form-input input-currency"
                                    min="0"
                                />
                                <p className="helper-text">In today's dollars</p>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Social Security (Annual)</label>
                                <NumberInput
                                    value={retirement.socialSecurity}
                                    onChange={(value) => updateRetirement('socialSecurity', value)}
                                    className="form-input input-currency"
                                    min="0"
                                />
                                <p className="helper-text">Estimated annual benefit</p>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Pension Income (Annual)</label>
                                <NumberInput
                                    value={retirement.pensionIncome}
                                    onChange={(value) => updateRetirement('pensionIncome', value)}
                                    className="form-input input-currency"
                                    min="0"
                                />
                                <p className="helper-text">If applicable</p>
                            </div>
                        </div>
                        <div className="metric-card" style={{marginTop: '1rem'}}>
                            <div className="metric-label">Gap to Fill from Portfolio</div>
                            <div className="metric-value">
                                {formatCurrency(Math.max(0, retirement.desiredIncome - retirement.socialSecurity - retirement.pensionIncome))}
                            </div>
                            <div className="metric-change">Annual withdrawal needed</div>
                        </div>
                    </div>

                    <div className="form-section">
                        <h2 className="section-header">Assumptions</h2>
                        <div className="form-grid">
                            <div className="form-group">
                                <label className="form-label">Inflation Rate</label>
                                <NumberInput
                                    value={retirement.inflationRate}
                                    onChange={(value) => updateRetirement('inflationRate', value)}
                                    className="form-input"
                                    step="0.001"
                                    min="0"
                                    max="0.1"
                                />
                                <p className="helper-text">Default: 3% (enter as 0.03)</p>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Pre-Retirement Return</label>
                                <NumberInput
                                    value={retirement.preRetirementReturn}
                                    onChange={(value) => updateRetirement('preRetirementReturn', value)}
                                    className="form-input"
                                    step="0.001"
                                    min="0"
                                    max="0.2"
                                />
                                <p className="helper-text">Default: 7% (enter as 0.07)</p>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Post-Retirement Return</label>
                                <NumberInput
                                    value={retirement.postRetirementReturn}
                                    onChange={(value) => updateRetirement('postRetirementReturn', value)}
                                    className="form-input"
                                    step="0.001"
                                    min="0"
                                    max="0.15"
                                />
                                <p className="helper-text">Default: 5% (enter as 0.05)</p>
                            </div>
                        </div>
                    </div>

                    <div className="form-section">
                        <h2 className="section-header">Retirement Readiness Analysis</h2>
                        
                        <div className="dashboard-grid">
                            <div className="metric-card">
                                <div className="metric-label">Capital Needed (4% Rule)</div>
                                <div className="metric-value">{formatCurrency(capitalNeeded)}</div>
                                <div className="metric-change">{formatCurrency(retirement.desiredIncome)} ÷ 0.04</div>
                            </div>
                            <div className="metric-card">
                                <div className="metric-label">Future Value of Savings</div>
                                <div className="metric-value">{formatCurrency(futureValueOfSavings)}</div>
                                <div className="metric-change">Current savings growing</div>
                            </div>
                            <div className="metric-card">
                                <div className="metric-label">FV of Contributions</div>
                                <div className="metric-value">{formatCurrency(futureValueOfContributions)}</div>
                                <div className="metric-change">Future contributions</div>
                            </div>
                            <div className="metric-card" style={{borderTop: '4px solid var(--accent-gold)'}}>
                                <div className="metric-label">Projected at Retirement</div>
                                <div className="metric-value">{formatCurrency(projectedRetirementSavings)}</div>
                                <div className="metric-change positive">Total projected</div>
                            </div>
                        </div>

                        <div className="metric-card" style={{marginTop: '2rem', padding: '3rem', borderTop: `4px solid ${retirementSurplus > 0 ? 'var(--success)' : 'var(--danger)'}`}}>
                            <div className="metric-label" style={{fontSize: '1rem'}}>
                                RETIREMENT {retirementSurplus > 0 ? 'SURPLUS' : 'SHORTFALL'}
                            </div>
                            <div className="metric-value" style={{fontSize: '3.5rem', color: retirementSurplus > 0 ? 'var(--success)' : 'var(--danger)'}}>
                                {formatCurrency(Math.abs(retirementSurplus))}
                            </div>
                            <div className={`status-badge ${retirementSurplus > 0 ? 'status-success' : 'status-danger'}`} style={{marginTop: '1rem'}}>
                                {retirementSurplus > 0 ? '✓ ON TRACK' : '⚠ NEEDS ADJUSTMENT'}
                            </div>
                        </div>

                        <div className="progress-container" style={{marginTop: '2rem'}}>
                            <div className="progress-label">
                                <span>Retirement Funding Progress</span>
                                <span>{formatPercent(projectedRetirementSavings / capitalNeeded)}</span>
                            </div>
                            <div className="progress-bar">
                                <div className="progress-fill" style={{width: `${Math.min((projectedRetirementSavings / capitalNeeded) * 100, 100)}%`}}></div>
                            </div>
                        </div>
                    </div>

                    {retirementSurplus < 0 && yearsToRetirement > 0 && (
                        <div className="form-section" style={{background: 'rgba(231, 76, 60, 0.05)', border: '2px solid var(--danger)'}}>
                            <h2 className="section-header" style={{color: 'var(--danger)'}}>Recommendations to Close the Gap</h2>
                            <div style={{padding: '1rem'}}>
                                <p style={{marginBottom: '1rem', fontWeight: 600}}>You need an additional {formatCurrency(Math.abs(retirementSurplus))} at retirement. Consider these options:</p>
                                <ul style={{paddingLeft: '2rem', lineHeight: '2'}}>
                                    <li><strong>Increase Annual Contributions:</strong> Save an additional {formatCurrency(Math.abs(retirementSurplus) / yearsToRetirement)} per year</li>
                                    <li><strong>Delay Retirement:</strong> Working 2-3 additional years significantly improves outcomes</li>
                                    <li><strong>Reduce Retirement Spending:</strong> Plan for {formatCurrency(retirement.desiredIncome - (Math.abs(retirementSurplus) / 25))} annual income instead</li>
                                    <li><strong>Optimize Investment Returns:</strong> Review asset allocation (consult advisor)</li>
                                    <li><strong>Maximize Social Security:</strong> Delaying to age 70 increases benefits by 8% per year</li>
                                </ul>
                            </div>
                        </div>
                    )}

                    <div className="form-section">
                        <h2 className="section-header">🤖 AI-Powered Retirement Analysis</h2>
                        <p style={{marginBottom: '1rem', color: 'var(--text-light)'}}>
                            Get personalized recommendations from Claude AI to optimize your retirement plan.
                        </p>
                        
                        <button 
                            className="ai-button" 
                            onClick={() => getAIRecommendations(`
You are a CFP® professional specializing in retirement planning. Analyze this retirement plan:

CLIENT PROFILE:
- Current Age: ${clientData.age}
- Retirement Age: ${clientData.retirementAge}
- Life Expectancy: ${clientData.lifeExpectancy}
- Years to Retirement: ${yearsToRetirement}
- Years in Retirement: ${yearsInRetirement}

CURRENT SITUATION:
- Current Retirement Savings: ${formatCurrency(retirement.currentSavings)}
- Annual Contributions: ${formatCurrency(retirement.annualContributions)}
- Pre-Retirement Return Assumption: ${formatPercent(retirement.preRetirementReturn)}

RETIREMENT GOALS:
- Desired Annual Income: ${formatCurrency(retirement.desiredIncome)}
- Social Security (annual): ${formatCurrency(retirement.socialSecurity)}
- Pension Income (annual): ${formatCurrency(retirement.pensionIncome)}
- Capital Needed (4% rule): ${formatCurrency(capitalNeeded)}

PROJECTIONS:
- Projected Retirement Savings: ${formatCurrency(projectedRetirementSavings)}
- ${retirementSurplus > 0 ? 'SURPLUS' : 'SHORTFALL'}: ${formatCurrency(Math.abs(retirementSurplus))}
- Funding Progress: ${formatPercent(projectedRetirementSavings / capitalNeeded)}

Provide 5-7 specific, actionable recommendations covering:
1. Assessment of plan viability (is it on track?)
2. If there's a shortfall, prioritized strategies to close the gap
3. If there's a surplus, opportunities to optimize (retire earlier, spend more, etc.)
4. Contribution strategy optimization
5. Asset allocation considerations given time horizon
6. Social Security claiming strategy
7. Tax-efficient withdrawal sequencing

Format as a numbered list. Be direct and specific with dollar amounts where appropriate. Focus on highest-impact changes.
                            `)}
                            disabled={isLoadingAI}
                        >
                            {isLoadingAI ? '⏳ Analyzing Your Plan...' : '🤖 Get AI Retirement Analysis'}
                        </button>

                        {isLoadingAI && (
                            <div className="ai-loading">
                                <div className="ai-loading-spinner"></div>
                                <p>Claude is analyzing your retirement plan...</p>
                            </div>
                        )}

                        {aiError && (
                            <div className="ai-error">
                                <strong>⚠️ Note:</strong> {aiError}
                            </div>
                        )}

                        {aiRecommendations && (
                            <div className="ai-recommendations-box">
                                <h3>💡 Claude's Retirement Analysis</h3>
                                <div className="ai-recommendations-content">
                                    {aiRecommendations}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            // Tax Efficiency Page
            const TaxEfficiencyPage = () => {
                const totalTaxableAccounts = taxAccounts.taxDeferred + taxAccounts.roth + taxAccounts.taxable;
                
                return (
                    <div className="fade-in">
                        <div className="page-header">
                            <h1 className="page-title">Tax-Efficient Asset Location</h1>
                            <p className="page-subtitle">Optimize which investments go in which account types</p>
                        </div>

                        <div className="form-section">
                            <h2 className="section-header">Current Account Balances</h2>
                            <div className="form-grid">
                                <div className="form-group">
                                    <label className="form-label">Tax-Deferred (401k, IRA)</label>
                                    <NumberInput
                                        value={taxAccounts.taxDeferred}
                                        onChange={(value) => updateTaxAccounts('taxDeferred', value)}
                                        className="form-input input-currency"
                                        min="0"
                                    />
                                    <p className="helper-text">Traditional 401k, Traditional IRA, etc.</p>
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Roth (Tax-Free)</label>
                                    <NumberInput
                                        value={taxAccounts.roth}
                                        onChange={(value) => updateTaxAccounts('roth', value)}
                                        className="form-input input-currency"
                                        min="0"
                                    />
                                    <p className="helper-text">Roth IRA, Roth 401k, etc.</p>
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Taxable Brokerage</label>
                                    <NumberInput
                                        value={taxAccounts.taxable}
                                        onChange={(value) => updateTaxAccounts('taxable', value)}
                                        className="form-input input-currency"
                                        min="0"
                                    />
                                    <p className="helper-text">Regular brokerage accounts</p>
                                </div>
                            </div>

                            <div className="dashboard-grid" style={{marginTop: '2rem'}}>
                                <div className="metric-card">
                                    <div className="metric-label">Tax-Deferred %</div>
                                    <div className="metric-value">{formatPercent(taxAccounts.taxDeferred / totalTaxableAccounts)}</div>
                                </div>
                                <div className="metric-card">
                                    <div className="metric-label">Roth %</div>
                                    <div className="metric-value">{formatPercent(taxAccounts.roth / totalTaxableAccounts)}</div>
                                </div>
                                <div className="metric-card">
                                    <div className="metric-label">Taxable %</div>
                                    <div className="metric-value">{formatPercent(taxAccounts.taxable / totalTaxableAccounts)}</div>
                                </div>
                            </div>
                        </div>

                        <div className="form-section">
                            <h2 className="section-header">Optimal Asset Location Strategy</h2>
                            <p style={{marginBottom: '2rem', color: 'var(--text-light)'}}>
                                Place investments in the right account types to minimize lifetime taxes. Green cells show optimal placement.
                            </p>

                            <div style={{overflowX: 'auto'}}>
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Asset Class</th>
                                            <th>Tax-Deferred (401k, IRA)</th>
                                            <th>Roth (Tax-Free)</th>
                                            <th>Taxable Brokerage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Bonds</strong></td>
                                            <td className="optimal-cell">✓ OPTIMAL</td>
                                            <td>Acceptable</td>
                                            <td style={{color: 'var(--danger)'}}>❌ Poor (taxed as ordinary income)</td>
                                        </tr>
                                        <tr>
                                            <td><strong>High-Yield Bonds</strong></td>
                                            <td className="optimal-cell">✓ OPTIMAL</td>
                                            <td>Good</td>
                                            <td style={{color: 'var(--danger)'}}>❌ Poor (high income tax)</td>
                                        </tr>
                                        <tr>
                                            <td><strong>REITs</strong></td>
                                            <td className="optimal-cell">✓ OPTIMAL</td>
                                            <td>Good</td>
                                            <td style={{color: 'var(--danger)'}}>❌ Poor (ordinary income)</td>
                                        </tr>
                                        <tr>
                                            <td><strong>High-Growth Stocks</strong></td>
                                            <td>Acceptable</td>
                                            <td className="optimal-cell">✓ OPTIMAL</td>
                                            <td>Good (long-term cap gains)</td>
                                        </tr>
                                        <tr>
                                            <td><strong>International Stocks</strong></td>
                                            <td style={{color: 'var(--warning)'}}>⚠ Poor (lose foreign tax credit)</td>
                                            <td>Good</td>
                                            <td className="optimal-cell">✓ OPTIMAL (foreign tax credit)</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tax-Managed Index Funds</strong></td>
                                            <td>Not needed</td>
                                            <td>Not needed</td>
                                            <td className="optimal-cell">✓ OPTIMAL</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Index Funds (Low Turnover)</strong></td>
                                            <td>Good</td>
                                            <td>Good</td>
                                            <td className="optimal-cell">✓ OPTIMAL (tax-efficient)</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Actively Managed Funds</strong></td>
                                            <td className="optimal-cell">✓ OPTIMAL</td>
                                            <td>Good</td>
                                            <td style={{color: 'var(--danger)'}}>❌ Poor (high turnover)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="form-section">
                            <h2 className="section-header">Key Principles of Tax-Efficient Location</h2>
                            
                            <div style={{display: 'grid', gap: '1.5rem'}}>
                                <div className="metric-card" style={{borderLeft: '4px solid var(--primary-blue)'}}>
                                    <h3 style={{color: 'var(--primary-blue)', marginBottom: '0.5rem'}}>1. Tax-Deferred Accounts (401k, Traditional IRA)</h3>
                                    <p><strong>Best for:</strong> Bonds, REITs, actively managed funds, high-yield investments</p>
                                    <p><strong>Why:</strong> Interest and dividends grow tax-deferred. You'll pay ordinary income tax on withdrawals, but deferral allows compounding to work its magic.</p>
                                </div>

                                <div className="metric-card" style={{borderLeft: '4px solid var(--accent-teal)'}}>
                                    <h3 style={{color: 'var(--accent-teal)', marginBottom: '0.5rem'}}>2. Roth Accounts (Roth IRA, Roth 401k)</h3>
                                    <p><strong>Best for:</strong> High-growth stocks, assets expected to appreciate significantly</p>
                                    <p><strong>Why:</strong> All growth is tax-free forever. Maximize the benefit by holding highest-growth potential assets here.</p>
                                </div>

                                <div className="metric-card" style={{borderLeft: '4px solid var(--accent-gold)'}}>
                                    <h3 style={{color: 'var(--accent-gold)', marginBottom: '0.5rem'}}>3. Taxable Brokerage</h3>
                                    <p><strong>Best for:</strong> Tax-efficient index funds, international stocks (foreign tax credit), municipal bonds</p>
                                    <p><strong>Why:</strong> Long-term capital gains taxed at preferential rates (0%, 15%, or 20%). Step-up in basis at death. Access to foreign tax credit for international dividends.</p>
                                </div>
                            </div>
                        </div>

                        <div className="summary-box">
                            <h3 className="summary-title">Example Optimization</h3>
                            <p style={{marginBottom: '1rem'}}>For a $350,000 portfolio with 60% stocks / 40% bonds:</p>
                            
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem', marginTop: '1rem'}}>
                                <div>
                                    <h4 style={{color: 'var(--primary-blue)', marginBottom: '0.5rem', fontSize: '1rem'}}>Tax-Deferred ($140,000)</h4>
                                    <ul style={{lineHeight: '1.8', paddingLeft: '1.25rem'}}>
                                        <li>100% Bonds</li>
                                        <li>Total: $140,000</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style={{color: 'var(--accent-teal)', marginBottom: '0.5rem', fontSize: '1rem'}}>Roth ($30,000)</h4>
                                    <ul style={{lineHeight: '1.8', paddingLeft: '1.25rem'}}>
                                        <li>100% Growth Stocks</li>
                                        <li>Total: $30,000</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style={{color: 'var(--accent-gold)', marginBottom: '0.5rem', fontSize: '1rem'}}>Taxable ($180,000)</h4>
                                    <ul style={{lineHeight: '1.8', paddingLeft: '1.25rem'}}>
                                        <li>Tax-efficient index: $150k</li>
                                        <li>International: $30k</li>
                                        <li>Total: $180,000</li>
                                    </ul>
                                </div>
                            </div>

                            <p style={{marginTop: '1.5rem', fontWeight: 600, color: 'var(--success)'}}>
                                <strong>Result:</strong> This allocation could save $50,000+ in taxes over 30 years compared to random placement.
                            </p>
                        </div>

                        <div className="form-section">
                            <h2 className="section-header">🤖 AI-Powered Asset Location Recommendations</h2>
                            <p style={{marginBottom: '1rem', color: 'var(--text-light)'}}>
                                Get personalized tax optimization strategies from Claude AI based on your portfolio.
                            </p>
                            
                            <button 
                                className="ai-button" 
                                onClick={() => getAIRecommendations(`
You are a CFP® professional specializing in tax-efficient investing. Analyze this portfolio allocation:

ACCOUNT BALANCES:
- Tax-Deferred (401k, Traditional IRA): ${formatCurrency(taxAccounts.taxDeferred)} (${formatPercent(taxAccounts.taxDeferred / (taxAccounts.taxDeferred + taxAccounts.roth + taxAccounts.taxable))})
- Roth (Tax-Free): ${formatCurrency(taxAccounts.roth)} (${formatPercent(taxAccounts.roth / (taxAccounts.taxDeferred + taxAccounts.roth + taxAccounts.taxable))})
- Taxable Brokerage: ${formatCurrency(taxAccounts.taxable)} (${formatPercent(taxAccounts.taxable / (taxAccounts.taxDeferred + taxAccounts.roth + taxAccounts.taxable))})

TOTAL PORTFOLIO: ${formatCurrency(taxAccounts.taxDeferred + taxAccounts.roth + taxAccounts.taxable)}

CLIENT CONTEXT:
- Current Age: ${clientData.age}
- Years to Retirement: ${yearsToRetirement}
- Tax Bracket Information: Not provided (assume moderate income)

Provide 5-7 specific recommendations covering:
1. Optimal asset location strategy for their account mix
   - What % of stocks vs bonds should go in each account type
   - Which specific asset classes (REITs, international, bonds, etc.) belong where
2. Account balance optimization
   - Is their account mix appropriate? Should they shift future contributions?
   - Roth conversion opportunities?
3. Specific rebalancing recommendations (if needed)
4. Estimated tax savings over 20-30 years with optimal placement
5. Year-by-year action plan (if major changes needed)
6. Considerations given their time horizon to retirement

Format as a numbered list. Be specific with percentages and dollar amounts. Focus on actionable steps they can take now.
                                `)}
                                disabled={isLoadingAI}
                            >
                                {isLoadingAI ? '⏳ Analyzing Portfolio...' : '🤖 Get AI Tax Optimization'}
                            </button>

                            {isLoadingAI && (
                                <div className="ai-loading">
                                    <div className="ai-loading-spinner"></div>
                                    <p>Claude is analyzing your tax optimization strategy...</p>
                                </div>
                            )}

                            {aiError && (
                                <div className="ai-error">
                                    <strong>⚠️ Note:</strong> {aiError}
                                </div>
                            )}

                            {aiRecommendations && (
                                <div className="ai-recommendations-box">
                                    <h3>💡 Claude's Tax Optimization Strategy</h3>
                                    <div className="ai-recommendations-content">
                                        {aiRecommendations}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // Monte Carlo Page
            const MonteCarloPage = () => (
                <div className="fade-in">
                    <div className="page-header">
                        <h1 className="page-title">Monte Carlo Simulation</h1>
                        <p className="page-subtitle">Advanced probabilistic retirement analysis with full customization</p>
                    </div>

                    <div className="form-section">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem'}}>
                            <h2 className="section-header" style={{marginBottom: 0, paddingBottom: 0, borderBottom: 'none'}}>Simulation Parameters</h2>
                            <button className="pull-data-btn" onClick={pullRetirementData}>
                                📊 Pull from Retirement Planning
                            </button>
                        </div>
                        <div className="form-grid">
                            <div className="form-group">
                                <label className="form-label">Starting Portfolio</label>
                                <NumberInput
                                    value={mcParams.startingValue}
                                    onChange={(value) => updateMcParams('startingValue', value)}
                                    className="form-input input-currency"
                                    min="0"
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Annual Withdrawal</label>
                                <NumberInput
                                    value={mcParams.annualWithdrawal}
                                    onChange={(value) => updateMcParams('annualWithdrawal', value)}
                                    className="form-input input-currency"
                                    min="0"
                                />
                                <p className="helper-text">Amount withdrawn first year</p>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Years in Retirement</label>
                                <NumberInput
                                    value={mcParams.yearsRetirement}
                                    onChange={(value) => updateMcParams('yearsRetirement', value)}
                                    className="form-input"
                                    min="10"
                                    max="50"
                                />
                            </div>
                        </div>

                        <h3 className="subsection-header">Asset Allocation (must total 100%)</h3>
                        <div className="form-grid">
                            <div className="form-group">
                                <label className="form-label">Stocks %</label>
                                <NumberInput
                                    value={mcParams.stockPct * 100}
                                    onChange={(value) => updateMcParams('stockPct', value / 100)}
                                    className="form-input"
                                    step="1"
                                    min="0"
                                    max="100"
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Bonds %</label>
                                <NumberInput
                                    value={mcParams.bondPct * 100}
                                    onChange={(value) => updateMcParams('bondPct', value / 100)}
                                    className="form-input"
                                    step="1"
                                    min="0"
                                    max="100"
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Cash %</label>
                                <NumberInput
                                    value={mcParams.cashPct * 100}
                                    onChange={(value) => updateMcParams('cashPct', value / 100)}
                                    className="form-input"
                                    step="1"
                                    min="0"
                                    max="100"
                                />
                            </div>
                        </div>
                        <p className="helper-text">Current total: {formatPercent(mcParams.stockPct + mcParams.bondPct + mcParams.cashPct)}</p>

                        <div className="toggle-container" style={{marginTop: '2rem'}}>
                            <div 
                                className={`toggle-switch ${showAdvancedMC ? 'active' : ''}`}
                                onClick={() => setShowAdvancedMC(!showAdvancedMC)}
                            >
                                <div className="toggle-slider"></div>
                            </div>
                            <span className="toggle-label">Show Advanced Parameters</span>
                        </div>

                        {showAdvancedMC && (
                            <>
                                <h3 className="subsection-header">Expected Returns & Volatility</h3>
                                <div className="form-grid">
                                    <div className="form-group">
                                        <label className="form-label">Stock Return</label>
                                        <NumberInput
                                            value={mcParams.stockReturn}
                                            onChange={(v) => updateMcParams('stockReturn', v)}
                                            className="form-input"
                                            step="0.001"
                                        />
                                        <p className="helper-text">Default: 0.10 (10%)</p>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Stock Volatility</label>
                                        <NumberInput
                                            value={mcParams.stockVol}
                                            onChange={(v) => updateMcParams('stockVol', v)}
                                            className="form-input"
                                            step="0.001"
                                        />
                                        <p className="helper-text">Default: 0.18 (18%)</p>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Bond Return</label>
                                        <NumberInput
                                            value={mcParams.bondReturn}
                                            onChange={(v) => updateMcParams('bondReturn', v)}
                                            className="form-input"
                                            step="0.001"
                                        />
                                        <p className="helper-text">Default: 0.045 (4.5%)</p>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Bond Volatility</label>
                                        <NumberInput
                                            value={mcParams.bondVol}
                                            onChange={(v) => updateMcParams('bondVol', v)}
                                            className="form-input"
                                            step="0.001"
                                        />
                                        <p className="helper-text">Default: 0.06 (6%)</p>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Cash Return</label>
                                        <NumberInput
                                            value={mcParams.cashReturn}
                                            onChange={(v) => updateMcParams('cashReturn', v)}
                                            className="form-input"
                                            step="0.001"
                                        />
                                        <p className="helper-text">Default: 0.02 (2%)</p>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Cash Volatility</label>
                                        <NumberInput
                                            value={mcParams.cashVol}
                                            onChange={(v) => updateMcParams('cashVol', v)}
                                            className="form-input"
                                            step="0.001"
                                        />
                                        <p className="helper-text">Default: 0.01 (1%)</p>
                                    </div>
                                </div>

                                <h3 className="subsection-header">Additional Parameters</h3>
                                <div className="form-grid">
                                    <div className="form-group">
                                        <label className="form-label">Inflation Rate</label>
                                        <NumberInput
                                            value={mcParams.inflationRate}
                                            onChange={(v) => updateMcParams('inflationRate', v)}
                                            className="form-input"
                                            step="0.001"
                                        />
                                        <p className="helper-text">Default: 0.025 (2.5%)</p>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Annual Fees</label>
                                        <NumberInput
                                            value={mcParams.fees}
                                            onChange={(v) => updateMcParams('fees', v)}
                                            className="form-input"
                                            step="0.0001"
                                        />
                                        <p className="helper-text">Default: 0.005 (0.5%)</p>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Tax Drag</label>
                                        <NumberInput
                                            value={mcParams.taxDrag}
                                            onChange={(v) => updateMcParams('taxDrag', v)}
                                            className="form-input"
                                            step="0.001"
                                        />
                                        <p className="helper-text">Default: 0.01 (1%)</p>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Social Security (Annual)</label>
                                        <NumberInput
                                            value={mcParams.socialSecurity}
                                            onChange={(v) => updateMcParams('socialSecurity', v)}
                                            className="form-input input-currency"
                                            min="0"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Pension (Annual)</label>
                                        <NumberInput
                                            value={mcParams.pension}
                                            onChange={(v) => updateMcParams('pension', v)}
                                            className="form-input input-currency"
                                            min="0"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Number of Simulations</label>
                                        <NumberInput
                                            value={mcParams.numSimulations}
                                            onChange={(v) => updateMcParams('numSimulations', v)}
                                            className="form-input"
                                            min="100"
                                            max="10000"
                                            step="100"
                                        />
                                        <p className="helper-text">More = slower but more accurate</p>
                                    </div>
                                </div>
                            </>
                        )}

                        <button 
                            className="btn btn-primary" 
                            onClick={runSimulation}
                            disabled={isSimulating}
                            style={{marginTop: '2rem'}}
                        >
                            {isSimulating ? `⏳ Running ${mcParams.numSimulations} Simulations...` : `▶ Run Monte Carlo Simulation (${mcParams.numSimulations} iterations)`}
                        </button>
                    </div>

                    {isSimulating && (
                        <div className="form-section">
                            <div className="loading-spinner"></div>
                            <p style={{textAlign: 'center', color: 'var(--text-light)'}}>Simulating 1,000 retirement scenarios...</p>
                        </div>
                    )}

                    {mcResults && !isSimulating && (
                        <>
                            <div className="tabs-container">
                                <button 
                                    className={`tab ${mcTab === 'results' ? 'active' : ''}`}
                                    onClick={() => setMcTab('results')}
                                >
                                    📊 Results Summary
                                </button>
                                <button 
                                    className={`tab ${mcTab === 'charts' ? 'active' : ''}`}
                                    onClick={() => setMcTab('charts')}
                                >
                                    📈 Charts & Visualizations
                                </button>
                                <button 
                                    className={`tab ${mcTab === 'data' ? 'active' : ''}`}
                                    onClick={() => setMcTab('data')}
                                >
                                    📋 Detailed Data
                                </button>
                            </div>

                            {mcTab === 'results' && (
                                <>
                                    <div className="mc-results">
                                        <div className="mc-result-card">
                                            <div className="metric-label">Success Rate</div>
                                            <div className={`mc-value ${
                                                mcResults.successRate >= 0.9 ? 'success' : 
                                                mcResults.successRate >= 0.7 ? 'warning' : 'danger'
                                            }`}>
                                                {formatPercent(mcResults.successRate)}
                                            </div>
                                            <div className={`status-badge ${
                                                mcResults.successRate >= 0.9 ? 'status-success' : 
                                                mcResults.successRate >= 0.7 ? 'status-warning' : 'status-danger'
                                            }`}>
                                                {mcResults.successRate >= 0.9 ? '✓ Excellent' : 
                                                 mcResults.successRate >= 0.7 ? '⚠ Acceptable' : '⚠ High Risk'}
                                            </div>
                                            <p className="helper-text" style={{marginTop: '1rem'}}>
                                                Survived {mcParams.yearsRetirement} years in {(mcResults.successRate * mcParams.numSimulations).toFixed(0)} of {mcParams.numSimulations} simulations
                                            </p>
                                        </div>

                                        <div className="mc-result-card">
                                            <div className="metric-label">Median Final Portfolio</div>
                                            <div className="mc-value">{formatCurrency(mcResults.median)}</div>
                                            <div className="metric-change">Most likely outcome</div>
                                        </div>

                                        <div className="mc-result-card">
                                            <div className="metric-label">10th Percentile</div>
                                            <div className="metric-value">{formatCurrency(mcResults.percentile10)}</div>
                                            <div className="metric-change">Conservative planning number</div>
                                        </div>

                                        <div className="mc-result-card">
                                            <div className="metric-label">90th Percentile</div>
                                            <div className="metric-value">{formatCurrency(mcResults.percentile90)}</div>
                                            <div className="metric-change">Optimistic scenario</div>
                                        </div>
                                    </div>

                                    <div className="summary-box">
                                        <h3 className="summary-title">Interpretation</h3>
                                        <p style={{marginBottom: '1rem'}}>
                                            Based on {mcParams.numSimulations} simulations:
                                        </p>
                                        <ul style={{paddingLeft: '2rem', lineHeight: '2'}}>
                                            <li>Success rate: <strong>{formatPercent(mcResults.successRate)}</strong> of lasting {mcParams.yearsRetirement} years</li>
                                            <li>Median outcome: <strong>{formatCurrency(mcResults.median)}</strong> remaining</li>
                                            <li>Worst 10%: <strong>{formatCurrency(mcResults.percentile10)}</strong></li>
                                            {mcResults.successRate < 0.85 && (
                                                <li style={{color: 'var(--danger)', fontWeight: 600}}>
                                                    ⚠️ Consider: reducing withdrawals, increasing stocks, or delaying retirement
                                                </li>
                                            )}
                                            {mcResults.successRate >= 0.95 && (
                                                <li style={{color: 'var(--success)', fontWeight: 600}}>
                                                    ✓ Excellent! You might be able to spend more or retire earlier
                                                </li>
                                            )}
                                        </ul>
                                    </div>
                                </>
                            )}

                            {mcTab === 'charts' && (
                                <div className="chart-container">
                                    <h3 className="subsection-header">Portfolio Value Over Time</h3>
                                    <div className="chart-wrapper">
                                        <MonteCarloChart 
                                            yearlyPercentiles={mcResults.yearlyPercentiles}
                                            yearsRetirement={mcParams.yearsRetirement}
                                        />
                                    </div>
                                    <div className="summary-box" style={{marginTop: '2rem'}}>
                                        <h3 className="summary-title">How to Read This Chart</h3>
                                        <ul style={{paddingLeft: '2rem', lineHeight: '1.8'}}>
                                            <li><strong>Green (90th):</strong> Best 10% of outcomes</li>
                                            <li><strong>Gold (Median):</strong> Most likely outcome</li>
                                            <li><strong>Red (10th):</strong> Worst 10% - use for conservative planning</li>
                                            <li><strong>Hover:</strong> See exact values at any year</li>
                                            <li><strong>Width of spread:</strong> Shows uncertainty/volatility</li>
                                        </ul>
                                    </div>
                                </div>
                            )}

                            {mcTab === 'data' && (
                                <div className="form-section">
                                    <h3 className="subsection-header">Year-by-Year Data</h3>
                                    <div style={{overflowX: 'auto'}}>
                                        <table style={{width: '100%', borderCollapse: 'collapse'}}>
                                            <thead>
                                                <tr style={{background: 'var(--primary-dark)', color: 'white'}}>
                                                    <th style={{padding: '1rem', textAlign: 'left'}}>Year</th>
                                                    <th style={{padding: '1rem', textAlign: 'right'}}>10th</th>
                                                    <th style={{padding: '1rem', textAlign: 'right'}}>25th</th>
                                                    <th style={{padding: '1rem', textAlign: 'right'}}>Median</th>
                                                    <th style={{padding: '1rem', textAlign: 'right'}}>75th</th>
                                                    <th style={{padding: '1rem', textAlign: 'right'}}>90th</th>
                                                    <th style={{padding: '1rem', textAlign: 'right'}}>Survival</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {mcResults.yearlyPercentiles.map((data, idx) => (
                                                    <tr key={idx} style={{borderBottom: '1px solid var(--border-light)'}}>
                                                        <td style={{padding: '0.75rem'}}>{idx}</td>
                                                        <td style={{padding: '0.75rem', textAlign: 'right'}}>{formatCurrency(data.p10)}</td>
                                                        <td style={{padding: '0.75rem', textAlign: 'right'}}>{formatCurrency(data.p25)}</td>
                                                        <td style={{padding: '0.75rem', textAlign: 'right', fontWeight: 'bold'}}>{formatCurrency(data.p50)}</td>
                                                        <td style={{padding: '0.75rem', textAlign: 'right'}}>{formatCurrency(data.p75)}</td>
                                                        <td style={{padding: '0.75rem', textAlign: 'right'}}>{formatCurrency(data.p90)}</td>
                                                        <td style={{padding: '0.75rem', textAlign: 'right'}}>{formatPercent(data.survival)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="summary-box" style={{marginTop: '2rem'}}>
                                        <h3 className="summary-title">Using This Data</h3>
                                        <ul style={{paddingLeft: '2rem', lineHeight: '1.8'}}>
                                            <li><strong>Export:</strong> Select all, copy, paste into Excel</li>
                                            <li><strong>Survival Rate:</strong> % of simulations with money remaining</li>
                                            <li><strong>Use 10th percentile</strong> for conservative planning</li>
                                        </ul>
                                    </div>
                                </div>
                            )}
                        </>
                    )}

                    {mcResults && !isSimulating && (
                        <div className="form-section">
                            <h2 className="section-header">🤖 AI-Powered Simulation Analysis</h2>
                            <p style={{marginBottom: '1rem', color: 'var(--text-light)'}}>
                                Get expert interpretation and recommendations from Claude AI.
                            </p>
                            
                            <button 
                                className="ai-button" 
                                onClick={() => getAIRecommendations(`
You are a CFP® analyzing Monte Carlo results. Target: 85-90% success rate.

RESULTS: ${formatPercent(mcResults.successRate)} success (${(mcResults.successRate * mcParams.numSimulations).toFixed(0)}/${mcParams.numSimulations})
- Median: ${formatCurrency(mcResults.median)}
- 10th: ${formatCurrency(mcResults.percentile10)}
- 90th: ${formatCurrency(mcResults.percentile90)}

PARAMETERS:
- Portfolio: ${formatCurrency(mcParams.startingValue)}
- Withdrawal: ${formatCurrency(mcParams.annualWithdrawal)} (${formatPercent(mcParams.annualWithdrawal / mcParams.startingValue)} rate)
- Years: ${mcParams.yearsRetirement}
- Allocation: ${formatPercent(mcParams.stockPct)}/${formatPercent(mcParams.bondPct)}/${formatPercent(mcParams.cashPct)}
- Income: SS ${formatCurrency(mcParams.socialSecurity)}, Pension ${formatCurrency(mcParams.pension)}

Provide 5-7 recommendations:
1. Viability assessment
2. If <85%: specific improvements (prioritized)
3. If >95%: optimization opportunities
4. Allocation review
5. Withdrawal rate evaluation
6. Risk mitigation strategies
7. Alternative scenarios to test

Be specific. Format as numbered list.
                                `)}
                                disabled={isLoadingAI}
                            >
                                {isLoadingAI ? '⏳ Analyzing...' : '🤖 Get AI Analysis'}
                            </button>

                            {isLoadingAI && (
                                <div className="ai-loading">
                                    <div className="ai-loading-spinner"></div>
                                    <p>Analyzing results...</p>
                                </div>
                            )}

                            {aiError && <div className="ai-error"><strong>⚠️</strong> {aiError}</div>}

                            {aiRecommendations && (
                                <div className="ai-recommendations-box">
                                    <h3>💡 Claude's Analysis</h3>
                                    <div className="ai-recommendations-content">
                                        {aiRecommendations}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );

            // Navigation
            const nav = [
                { id: 'dashboard', label: 'Dashboard', icon: '📊' },
                { id: 'networth', label: 'Net Worth', icon: '💰' },
                { id: 'retirement', label: 'Retirement', icon: '🏖️' },
                { id: 'taxefficiency', label: 'Tax Efficiency', icon: '📈' },
                { id: 'montecarlo', label: 'Monte Carlo', icon: '🎲' },
            ];

            return (
                <div className="app-container">
                    <button 
                        className="mobile-menu-toggle"
                        onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                        aria-label="Toggle menu"
                    >
                        {mobileMenuOpen ? '✕' : '☰'}
                    </button>

                    <div className={`sidebar ${mobileMenuOpen ? 'mobile-open' : ''}`}>
                        <div className="sidebar-header">
                            <div className="logo">Financial Planning Pro</div>
                            <div className="logo-subtitle">Complete CFP® Platform</div>
                        </div>
                        <div className="nav-section">
                            <div className="nav-section-title">Planning Tools</div>
                            {nav.map(item => (
                                <div 
                                    key={item.id}
                                    className={`nav-item ${currentPage === item.id ? 'active' : ''}`}
                                    onClick={() => setCurrentPage(item.id)}
                                >
                                    <span className="nav-icon">{item.icon}</span>
                                    <span>{item.label}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="main-content">
                        {currentPage === 'dashboard' && <Dashboard />}
                        {currentPage === 'networth' && <NetWorthPage />}
                        {currentPage === 'retirement' && <RetirementPage />}
                        {currentPage === 'taxefficiency' && <TaxEfficiencyPage />}
                        {currentPage === 'montecarlo' && <MonteCarloPage />}
                    </div>
                </div>
            );
        }

        // Render App
        ReactDOM.render(<FinancialPlanningApp />, document.getElementById('root'));
    </script>
</body>
</html>
